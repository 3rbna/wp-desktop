version: 2
jobs:
  build:
    macos:
      xcode: "8.3.3"
    steps:
      - checkout
      - run:
          name: Install nvm / node
          command: |
            curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.2/install.sh | bash
      - run: echo "source $HOME/.nvm/nvm.sh && nvm install 7.4.0"
      - run: cd project && submodule init
      - run: cd project && submodule update --remote --force
      - run: openssl aes-256-cbc -d -in project/desktop-config/calypso-secrets.enc -out project/calypso/config/secrets.json -k "${CALYPSO_SECRETS_KEY}"
      - run: openssl aes-256-cbc -d -in project/resource/win32-secrets-tar.gz.enc -out project/resource/win32-secrets-tar.gz -k "${CALYPSO_SECRETS_KEY}"
      - run: tar -C project/resource/ -zxvf project/resource/win32-secrets-tar.gz
      - run: openssl aes-256-cbc -d -in project/resource/developer-id.p12.enc -out project/resource/secrets/developer-id.p12 -k "${CALYPSO_SECRETS_KEY}"
      - run: security import project/resource/secrets/developer-id.p12 -k ~/Library/Keychains/circle.keychain -P ${DEVELOPER_ID_CERTIFICATE_PASSWORD}
      - run: security find-identity -p codesigning
      - run: brew update
      - run: brew cask install xquartz
      - run: brew install wine makensis mono gnu-tar
      - run: gem install fpm
      - run: cd project && make distclean
      - run: echo make package-osx
      - run: echo make package-win32
      - run: echo make package-linux
      - run: brew tap tcnksm/ghr
      - run: brew install ghr
      - run: echo ghr -t ${GITHUB_ACCESS_TOKEN} -u automattic -r wp-desktop ${CIRCLE_TAG} release/

